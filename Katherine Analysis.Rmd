---
title: "Katherine Analysis"
output:
  html_document:
    df_print: paged
    toc: yes
  html_notebook:
    highlight: tango
    theme: cerulean
    toc: yes
---
# Housekeeping
### Preamble

By Katherine Duchesneau 

We are working with the roots Lesion and Mycorrhiza dataset for now. 

### R details

This section contains all the necessary details about the R version and package version used to run this Notebook.

  * File creation date: `r Sys.Date()`
  * `r R.version.string`
  * `tidyverse` package version: `r packageVersion("tidyverse")`
  * `lme4` package version `r packageVersion("lme4")`
  * `MASS` package version `r packageVersion("MASS")`
  * `MuMIn` package version `r packageVersion("MuMIn")`
  * `emmeans` package version `r packageVersion("emmeans")`
  * `boot` package version `r packageVersion("boot")`
  * `brms` package version `r packageVersion("brms")`
  * `loo` package version `r packageVersion("loo")`
  * `fitdistrplus` package version `r packageVersion("fitdistrplus")`
  * `mefa` package version `r packageVersion("mefa")`
  * `library(devtools)` and `install_github("vqv/ggbiplot")` package version `r packageVersion("ggbiplot")`
  * `vegan` package version `r packageVersion("vegan")`
  * `glmmADMB` package version `r packageVersion("glmmADMB")`
  * `car` package version `r packageVersion("car")`
  * `factoextra` package version `r packageVersion("factoextra")`
  * `pvclust` package version `r packageVersion("pvclust")`
  * `effects` package version `r packageVersion("effects")`
  * `coefplot2` package version `r packageVersion("coefplot2")`
  * `bbmle` package version `r packageVersion("bbmle")`
  * `gridExtra` package version `r packageVersion("gridExtra")`
  
  
### Load Packages and Functions

```{r Load_packages and functions, message=FALSE, warning=FALSE}
library(tidyverse)
library(lme4)
library(MASS)
library(MuMIn)
library(emmeans)
library(boot)
library(brms)
library(loo)
library(fitdistrplus)
library(mefa)
library(ggbiplot)
library(pvclust)
library(vegan)
library(ggbiplot)
library(factoextra)
library(glmmADMB)
library(car)
library(effects)
library(coefplot2)
library(bbmle)
library(gridExtra)
library(corrplot)
library(ade4)
```


Load a custome theme for clean, readable graphs:

```{r echo=F}
# theme_simple() a homemade function from the Colautti lab (2017) to standardize figures
theme_simple <- function (base_size = 16, base_family = "") {
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.text = element_text(colour = "black"),
      axis.title.x = element_text(size=18),
      axis.text.x = element_text(size=16, face= "italic"),
      axis.title.y = element_text(size=18, angle=90), 
      axis.text.y = element_text(size=16),
      axis.ticks = element_blank(),
      panel.background = element_rect(fill="white"),
      panel.border = element_blank(),
      plot.title=element_text(face="bold", size=24)
      #      legend.position="none"
    )
}

grid_arrange_shared_legend <-
  function(...,
           ncol = length(list(...)),
           nrow = 1,
           position = c("bottom", "right")) {
    
    plots <- list(...)
    position <- match.arg(position)
    g <-
      ggplotGrob(plots[[1]] + theme(legend.position = position))$grobs
    legend <- g[[which(sapply(g, function(x)
      x$name) == "guide-box")]]
    lheight <- sum(legend$height)
    lwidth <- sum(legend$width)
    gl <- lapply(plots, function(x)
      x + theme(legend.position = "none"))
    gl <- c(gl, ncol = ncol, nrow = nrow)
    
    combined <- switch(
      position,
      "bottom" = arrangeGrob(
        do.call(arrangeGrob, gl),
        legend,
        ncol = 1,
        heights = grid::unit.c(unit(1, "npc") - lheight, lheight)
      ),
      "right" = arrangeGrob(
        do.call(arrangeGrob, gl),
        legend,
        ncol = 2,
        widths = grid::unit.c(unit(1, "npc") - lwidth, lwidth)
      )
    )
    
    grid::grid.newpage()
    grid::grid.draw(combined)
    
    # return gtable invisibly
    invisible(combined)
    
  }

```

Overdispersion function, tests for overdispersion in GLMM:

```{r echo=F}
overdisp_fun <- function(model) {
  ## number of variance parameters in an n-by-n variance-covariance matrix
  vpars <- function(m) {
    nrow(m) * (nrow(m) + 1)/2
  }
  # The next two lines calculate the residual degrees of freedom
  model.df <- sum(sapply(VarCorr(model), vpars)) + length(fixef(model))
  rdf <- nrow(model.frame(model)) - model.df
  # extracts the Pearson residuals
  rp <- residuals(model, type = "pearson")
  Pearson.chisq <- sum(rp^2)
  prat <- Pearson.chisq/rdf
  # Generates a p-value. If less than 0.05, the data are overdispersed.
  pval <- pchisq(Pearson.chisq, df = rdf, lower.tail = FALSE)
  c(chisq = Pearson.chisq, ratio = prat, rdf = rdf, p = pval)
}

residfit <- function (model, col="black") {
  f<-fitted(model)
  r<-resid(model, type='pearson')
  plot(f, r, col=col, main='Residuals vs. Fitted')
  L1<-loess(r~f)
  fvec = seq(min(f),max(f),length.out=1000)
  lines(fvec,predict(L1,fvec),col='red')
}

#do the same for the Scale-Location plot
scaleloc <- function(model,col="black") {
  f <- fitted(model)
  r <- sqrt(abs(residuals(model, type='pearson'))) #transformed pearson residuals
  plot(f,r,col=col, main='Scale-Location Plot') 
  L1 <- loess(r~f)
  fvec = seq(min(f),max(f),length.out=1000)
  lines(fvec,predict(L1,fvec),col=2)
}
```

# Introducing the Data 

### Load/ Modify data: Co-occurence
```{r Introduce co-occurence dataset, message=FALSE, warning=FALSE, echo=FALSE}
mdata <- read.csv("CSV/Assessing_Oct_20.csv",stringsAsFactors=F)
indiv <- mdata$CODE[!mdata$CODE==""]
tdata <- mdata[grep("[0-9]+",mdata$Cross),]
nrow(tdata)/length(indiv)

# This is not the same because some individuals just had the totals not the cooccurence data
## THE COMMENT IS NOT CLEAR, EXPLAIN...
indiv2 <- tdata$CODE[!tdata$CODE==""]
nrow(tdata)/length(indiv2)
indiv2 <- data.frame(indiv2)
indiv2 <- mefa:::rep.data.frame(indiv2,each=100)
fdata <- cbind(indiv2,tdata)
fdata <- fdata[,-c(2,3,4,9,14,17,18)]

# Cleaning up the occurence data
## CLEANING UP HOW?
fdata[is.na(fdata)] <- 0
fdata$Lesion<-rowSums(fdata[,2:4])
fdata[fdata$Lesion>1,]
fdata$Mycorrhiza<-rowSums(fdata[,6:8])
fdata[fdata$Mycorrhiza>1,]
fdata <- fdata[,-c(2:4,6:8)]

#### Checking data for problems ####

summary(fdata)
fdata$None.Path <- as.integer(fdata$None.Path)
fdata$None.Myc <- as.integer(fdata$None.Myc)
fdata[is.na(fdata)] <- 0 


sherb <- fdata$Herbivory+fdata$None.Herb
fdata[sherb!=1,]
fdata[sherb!=1,"None.Herb"]<-1

# Are all the sums equal to 100 for herb? 
dframeHerb <- data.frame(counter=NA, Indiv2=NA,Sum=NA)
c <- 1
for (i in unique(fdata$indiv2)){
  dframeHerb[c,] <- NA
  subdata <- fdata[fdata$indiv2==i,]
  dframeHerb$counter[c] <- c
  dframeHerb$Indiv2[c] <- i
  dframeHerb$Sum[c] <- sum(subdata[,"Herbivory"]+subdata[,"None.Herb"])
  subdata <- NA
  c <- c + 1
}
dframeHerb[dframeHerb$Sum!=100,]


# Are all the sums equal to 100 for Mycorrhiza? 
dframeMyc <- data.frame(counter=NA, Indiv2=NA,Sum=NA)
c <- 1
for (i in unique(fdata$indiv2)){
  dframeMyc[c,] <- NA
  subdata <- fdata[fdata$indiv2==i,]
  dframeMyc$counter[c] <- c
  dframeMyc$Indiv2[c] <- i
  dframeMyc$Sum[c] <- sum(subdata[,"Mycorrhiza"]+subdata[,"None.Myc"])
  subdata <- NA
  c <- c + 1
}
dframeMyc[dframeMyc$Sum!=100,]


# Are all the sums equal to 100 for Lesions? 
dframeLesion <- data.frame(counter=NA, Indiv2=NA,Sum=NA)
c <- 1
for (i in unique(fdata$indiv2)){
  dframeLesion[c,] <- NA
  subdata <- fdata[fdata$indiv2==i,]
  dframeLesion$counter[c] <- c
  dframeLesion$Indiv2[c] <- i
  dframeLesion$Sum[c] <- sum(subdata[,"Lesion"]+subdata[,"None.Path"])
  subdata <- NA
  c <- c + 1
}
dframeLesion[dframeLesion$Sum!=100,]


# Separating "Individual" into: pop,location,species columns 
fdata$pop <- gsub("^([0-9]+)[I,O][A-Z]+.*","\\1",fdata$indiv)
fdata$location <- gsub("^[0-9]+([I,O])[A-Z]+.*","\\1",fdata$indiv)
fdata$species <- sub("^[0-9]+[I,O]([A-Z]+).*","\\1",fdata$indiv)
fdata$location <- as.factor(fdata$location)
fdata$species <- as.factor(fdata$species)
fdata$pop <- as.factor(fdata$pop)
fdata$indiv2 <- as.character(fdata$indiv2)
summary(fdata)
fdata %>% drop_na()->fdata

fdata$None.Myc <- as.factor(fdata$None.Myc)
fdata$Herbivory <- as.factor(fdata$Herbivory)
fdata$Mycorrhiza <- as.factor(fdata$Mycorrhiza)
fdata$Lesion <- as.factor(fdata$Lesion)
fdata$None.Herb <- as.factor(fdata$None.Herb)
fdata$None.Path <- as.factor(fdata$None.Path)
summary(fdata)
```
```{R gather dataframe}
length(unique(fdata$indiv2))
Cross<- data.frame(c(rep(1:100, times=225)))
fdatac <- cbind(fdata,Cross)
colnames(fdatac)[11]<-"cross"
fdatac %>% gather(Trait, Value, c(4,6,7)) -> fdata_gather # The warning is an inconsequential bug from tidyverse (https://github.com/tidyverse/tidyr/issues/386)
fdata_gather$Value<-as.numeric(fdata_gather$Value)
fdata_gather$Trait<-as.factor(fdata_gather$Trait)
fdata_gather <- fdata_gather[,-c(2:4)]
```

### Load/ Modify data: Totals
```{r Introduce total dataset, message=FALSE, warning=FALSE, echo=FALSE}
mdata<-read.csv("CSV/Assessing_Oct_20.csv",stringsAsFactors=F)
indiv<-mdata$CODE[!mdata$CODE==""]
tdata<-mdata[mdata$Slide=="TOTAL",]
length(indiv)
nrow(tdata)

ndata<-cbind(indiv,tdata)
ndata<-ndata[,-c(2,3,4,9,14,17:37)]
ndata$None.Path<-as.integer(ndata$None.Path)
ndata$Lesions<-as.integer(100-ndata$None.Path)
ndata$None.Myc<-as.integer(ndata$None.Myc)
ndata$Mycorrhiza<-as.integer(100-ndata$None.Myc)

# Checking data for problems
problemsPath<-ndata[!rowSums(ndata[,c(2:5)])==100,]
problemsHyph<-ndata[!rowSums(ndata[,c(6:9)])==100,]
problemsHerb<-ndata[!rowSums(ndata[,c(10:11)])==100,]

# Separating "Individual" into: pop,location,species columns 
ndata$pop<-gsub("^([0-9]+)[I,O][A-Z]+.*","\\1",ndata$indiv)
ndata$location<-gsub("^[0-9]+([I,O])[A-Z]+.*","\\1",ndata$indiv)
ndata$species<-gsub("^[0-9]+[I,O]([A-Z]+).*","\\1",ndata$indiv)
ndata$location<-as.factor(ndata$location)
ndata$species<-as.factor(ndata$species)
ndata$pop<-as.factor(ndata$pop)

#### Totalling the scores####
binlesion<-cbind(ndata$None.Path,100-ndata$None.Path)
binmycorr<-cbind(ndata$None.Myc,100-ndata$None.Myc)
binherbivory<-cbind(ndata$None.Herb,100-ndata$None.Herb)
summary(ndata)

# scale data (only need to scale the numerical variables!)
numcols <- grep("^None.",names(ndata))
ndatas <- ndata
ndatas[,numcols] <- scale(ndatas[,numcols])
```

### Field survey data

```{r}
FloristicSurvey <-read.csv("CSV/May_2017_FloristicSurvey_summer2016.csv", sep="\t")
PlantLength <- read.csv("CSV/May_2017_PlantLength_summer2016.csv", sep="\t")
Soil_characteristics <- read.csv("CSV/Soil_characteristics.txt", sep="\t")

#Restructuring
head(PlantLength)
str(PlantLength)
colnames(PlantLength)[1] <- "Population"
PlantLength$Population<-as.factor(PlantLength$Population)
PlantLength$Location<-as.factor(PlantLength$Location)

FloristicSurvey$Population<-as.factor(FloristicSurvey$Population) # Make the population a factor and not an interger
FloristicSurvey[is.na(FloristicSurvey)] <- 0
sum(row.has.na <- apply(FloristicSurvey, 1, function(x){any(is.na(x))}))
```

### Root size
```{r}
Root_size <-read.csv("CSV/Root_size.csv")
Root_size$pop<-gsub("^([0-9]+)[I,O][A-Z]+.*","\\1",Root_size$indiv)
Root_size$location<-gsub("^[0-9]+([I,O])[A-Z]+.*","\\1",Root_size$indiv)
Root_size$species<-gsub("^[0-9]+[I,O]([A-Z]+).*","\\1",Root_size$indiv)
Root_size$location<-as.factor(Root_size$location)
Root_size$species<-as.factor(Root_size$species)
Root_size$pop<-as.factor(Root_size$pop)
```

### Variable descriptions

The variables are:

Co-occurence:

  * **indiv2:** The unique code given to a sample. In this dataset the unique sample code repeats 100 times for each cross where an observation was taken on the root sample. 

  * **None.Path:** A binary representation of whether a sign of pathogen activity was recorded (0) or not (1).
  
  * **Lesion:** The counterpart to the previous variable (None.Path). A binary representation of whether a sign of pathogen activity was recorded (1) or not (0).

  * **None.Myc:** A binary representation of whether a sign of myccorhizal activity was recorded (0) or not (1).

  * **Mycorrhiza:** The counterpart to the previous variable (None.Myc). A binary representation of whether a sign of mycorrhizal activity was recorded (1) or not (0).
    
  * **None.Herb:** A binary representation of whether herbivory was recorded (0) or not (1).

  * **Herbivory:** The counterpart to the previous variable (None.Herb). A binary representation of whether Herbivoryn was recorded (1) or not (0).

  * **Population (pop):** The coding number representing the population at which the sample was collected. 

  * **location:** A code representing the whether the sample was collected inside a Alliaria petiolata population (I) or whther it was collected at least 7 m outside of he furthest individual in the A. petiolata population (O).
  
  * **species:** The particular species to which the sample belongs.

  * **Cross:** The particular cross number where the data was recorded on the individual sample. 
  
Total scores:

  * **indiv:** The unique code given to a sample. 
  
  * **Decay:** The total number of crosses where decay was recorded an individual sample when doing a total of 100 crosses/ sample.

  * **Pathogen:** The total number of crosses where pathogen was recorded on an individual sample when doing a total of 100 crosses/ sample.

  * **Hyphae:** The total number of crosses where non-myccorhizal hyphae was recorded on an individual sample when doing a total of 100 crosses/ sample.

  * **None.Path:** The total number of crosses where no signs of pathogen activities were recorded on an individual sample when doing a total of 100 crosses/ sample. Note that the total of Decay, Pathogen, Hyphae, and None.Path must come to 100 per individual to account for all 100 crosses.

  * **Arbuscule:** The total number of crosses where an arbuscule was recorded on an individual sample when doing a total of 100 crosses/ sample.

  * **Vesicules:** The total number of crosses where a vesicule was recorded on an individual sample when doing a total of 100 crosses/ sample.
  
  * **M_Hyphae:** The total number of crosses where myccorhizal hyphae was recorded on an individual sample when doing a total of 100 crosses/ sample.
  
  * **None.Myc:** The total number of crosses where no signs of mycorrhizal activities were recorded on an individual sample when doing a total of 100 crosses/ sample. Note that the total of Arbuscules, Vesicules, M_Hyphae, and None.Myc must come to 100 per individual to account for all 100 crosses.
  
  * **Herbivory:** The total number of crosses where herbivory was recorded on an individual sample when doing a total of 100 crosses/ sample.
  
  * **None.Herb:** The total number of crosses where no signs of herbivory was recorded on an individual sample when doing a total of 100 crosses/ sample. Note that the total of Herbivory, and None.Herb must come to 100 per individual to account for all 100 crosses.

  * **Population (pop):** The coding number representing the population at which the sample was collected. 

  * **location:** A code representing the whether the sample was collected inside a Alliaria petiolata population (I) or whther it was collected at least 7 m outside of he furthest individual in the A. petiolata population (O).
  
  * **species:** The particular species to which the sample belongs.
  

  
# Reviewing of hypotheses:

## Question 1: Is there evidence that Mycorrhizal colonization provides protection against root pathogen damage? 

## Question 2: Do these effects vary among species?

### Hypothesis 1


Mycorrhizal colonization protects roots from lesions and herbivory.
```{r echo=FALSE}
set.seed(3242)
y<-data.frame(rnorm(100,sd=7))
colnames(y)<-c("y")
y$y<-sort(y$y)
x<-data.frame(-y+rnorm(100))
colnames(x)<-c("x")
df <- cbind(x,y)
colnames(df)<-c("x","y")
df$Location <- c(rep("Out",nrow(df)/2),rep("In",nrow(df)/2))

ggplot(data=df, aes(x,y))+geom_smooth(method="lm", se=F)+geom_point(size=4,alpha=0.3)+
  theme_simple()+labs(x="Mycorrhizal Colonization (%)", y="Lesions (%)")+
  theme(axis.text.x = element_blank(),axis.text.y = element_blank())
```

### Hypothesis 2

A. petiolata invasion reduces mycorrhizal colonization and increases pathogen colonization and herbivory
```{r echo=FALSE}
ggplot(df, aes(x,y, colour=Location))+geom_smooth(method="lm", se=F)+
  geom_point(size=4,alpha=0.3)+theme_simple()+
  labs(x="Mycorrhizal Colonization (%)", y="Lesions (%)")+
  theme(axis.text.x = element_blank(),axis.text.y = element_blank())+
  scale_color_brewer(palette="Dark2")
```

### Hypothesis 3

Cycorrhizal colonization is reduced in the presence of A. petiolata
```{r echo=FALSE}
df$y2<-df$y
df$y2[df$Location=="In"]<-df$y2[df$Location=="In"]+10
ggplot(df, aes(x,y2, colour=Location))+geom_smooth(method="lm", se=F)+
  geom_point(size=4,alpha=0.3)+
  theme_simple()+labs(x="Mycorrhizal Colonization (%)", y="Lesions (%)")+
  theme(axis.text.x = element_blank(),axis.text.y = element_blank())+
  scale_color_brewer(palette="Dark2")
```

### Hypothesis 4

Mycorrhizal protection is completely lost in the presence of A. petiolata
```{r echo=FALSE}
df$y2<-df$y
set.seed (238.4)
df$y2[df$Location=="In"]<-rnorm(nrow(df)/2,mean=10)
ggplot(df, aes(x,y2, colour=Location))+geom_smooth(method="lm", se=F)+
  geom_point(size=4,alpha=0.3)+
  theme_simple()+labs(x="Mycorrhizal Colonization (%)", y="Lesions (%)")+
  theme(axis.text.x = element_blank(),axis.text.y = element_blank())+
  scale_color_brewer(palette="Dark2")
```

## Molecular data Hypothesis

### Hypothesis 1

A. petiolata invasion changes the diversity of mycorrhizal and other fungal species present in the soil.

I will find that the molecular data from the soil extraction supports this claim by having a reduced biodiversity and abundance of mycorrhiza in samples taken inside A. petiolata populations. 

### Hypothesis 2

There will be a negative correlation between mycorrhizal and fungal pathogen diversity.

# Field Data Analysis

## Plant length and GM presence 

```{r}
row.has.na <- apply(PlantLength, 1, function(x){any(is.na(x))})
sum(row.has.na) 
PlantLength.filtered <- PlantLength[!row.has.na,]# Removed all the rows with NAs
PlantLength.filtered$Pop <- as.factor(PlantLength.filtered$Pop)

car::qqp(PlantLength$Length_plant, "norm")
shapiro.test(PlantLength$Length_plant)

mod1<-lm(Length_plant~Location*Species, data=PlantLength.filtered)

bc<-boxcox(mod1, lambda = seq(-2, 2, 0.1))
lambda <- bc$x[which.max(bc$y)]
PlantLength.filtered <- cbind(PlantLength.filtered, ((PlantLength.filtered$Length_plant^lambda)-1)/lambda)
names(PlantLength.filtered)[length(PlantLength.filtered)] <- "Yprime"
mod1BC <- lm(Yprime~Location*Species, data=PlantLength.filtered) 

par(mfrow = c(2, 2))
plot(mod1BC)
# This is basically a log transformation. 

# Multicolinearity?
car::vif(mod1BC)
sqrt(car::vif(mod1BC)) > 2


mod1<-lmer(log(Length_plant)~Location*Species+(1|Pop), data=PlantLength.filtered)

mod2<-lmer(log(Length_plant)~Location+(1|Pop), data=PlantLength.filtered)

mod3<-lmer(log(Length_plant)~1+(1|Pop), data=PlantLength.filtered)

AICres <- model.sel(mod1,mod2,mod3)
r.squaredLR(mod1)
summary(mod1)
confint(mod1)


```


## Floristic composition and GM presence

### Cluster analysis
```{r}
# Ward Hierarchical Clustering with Bootstrapped p values
#do they cluster by population?
FloristicSurvey[is.na(FloristicSurvey)] <- 0
mydata<-t(data.frame(FloristicSurvey[,1],FloristicSurvey[,4:55]))
my.names <- mydata[1,]
colnames(mydata) <- my.names
mydata <- mydata[-1,]
d <- dist(t(mydata), method = "euclidean") # distance matrix
fit <- hclust(d, method = "ward.D")
fitd <- as.dendrogram(fit)

par(mfrow=c(3,2))
plot(fit,cex=0.4,main="Clustering with populations")
plot(cut(fitd, h=10)$upper, main="Upper tree of cut at h=10")
plot(cut(fitd, h=10)$lower[[1]], main="First branch of lower tree with cut at h=10")
plot(cut(fitd, h=10)$lower[[2]], main="Second branch of lower tree with cut at h=10")
plot(cut(fitd, h=10)$lower[[3]], main="Third branch of lower tree with cut at h=10")
plot(cut(fitd, h=10)$lower[[4]], main="Fourth branch of lower tree with cut at h=10")

#do they cluster by GM coverage?
FloristicSurvey[is.na(FloristicSurvey)] <- 0
#this will just make the dendogram easier to see
FloristicSurvey$GM_Coverage_category<-cut(FloristicSurvey$GM_Coverage, c(-Inf,25,50,75,100), labels = c("None", "ML", "MH", "High"))
mydata<-t(data.frame(FloristicSurvey[,56],FloristicSurvey[,4:55]))
my.names <- mydata[1,]
colnames(mydata) <- my.names
mydata <- mydata[-1,]
d <- dist(t(mydata), method = "euclidean") # distance matrix
fit <- hclust(d, method = "ward.D")
fitd <- as.dendrogram(fit)
FloristicSurvey$GM_Coverage_category<-cut(FloristicSurvey$GM_Coverage, c(-Inf,5,30,50,70,95,100), labels = c("None", "Low", "Med_Low", "Med_High", "High", "Overtaken"))

par(mfrow=c(3,2))
plot(fit,cex=0.4,main="Clustering with coverage")
plot(cut(fitd, h=10)$upper, main="Upper tree of cut at h=10")
plot(cut(fitd, h=10)$lower[[1]], main="First branch of lower tree with cut at h=10")
plot(cut(fitd, h=10)$lower[[2]], main="Second branch of lower tree with cut at h=10")
plot(cut(fitd, h=10)$lower[[3]], main="Third branch of lower tree with cut at h=10")
plot(cut(fitd, h=10)$lower[[4]], main="Fourth branch of lower tree with cut at h=10")
```

### NMDS 
```{r}
# https://jonlefcheck.net/2012/10/24/nmds-tutorial-in-r/
# https://oliviarata.wordpress.com/2014/04/17/ordinations-in-ggplot2/
#Make a matrix with no row or column equal to 0 (do not enclude the env variable (GM COVERAGE))
FloristicSurvey$GM_Coverage_category<-cut(FloristicSurvey$GM_Coverage, c(-Inf,25,50,75,100), labels = c("None to Low","Medium", "High", "Overtaken"))
table(FloristicSurvey$GM_Coverage_category)
M <- as.matrix(FloristicSurvey[1:198,4:56])
M[is.na(M)] <- 0
rownames(M) <- FloristicSurvey$Population
M<-M[-c(130,133),]
M<-M[,-45]
GM_coverage_df <- data.frame(M[,52])
M<-M[,-52]
class(M) <- "numeric"


# with vegdist from Bray to seroeson: add binary = T 
dist_FloristicSurvey <- vegdist(M, method = "bray", binary = T)
meta.nmds.FloristicSurvey2D <- metaMDS(dist_FloristicSurvey, k=2, trymax = 1000)

str(meta.nmds.FloristicSurvey2D)
stressplot(meta.nmds.FloristicSurvey2D)


FloristicSurvey_envfit <- envfit(meta.nmds.FloristicSurvey2D, env = GM_coverage_df, perm = 999) #standard envfit
FloristicSurvey_envfit

#data for plotting 
##NMDS points
FloristicSurvey.NMDS.data<-GM_coverage_df 
FloristicSurvey.NMDS.data$NMDS1<-meta.nmds.FloristicSurvey2D$points[ ,1] 
FloristicSurvey.NMDS.data$NMDS2<-meta.nmds.FloristicSurvey2D$points[ ,2] 
colnames(FloristicSurvey.NMDS.data)[1] <- "GM_Coverage"

# data for the envfit arrows
env.scores.FloristicSurvey <- as.data.frame(scores(FloristicSurvey_envfit, display = "vectors")) #extracts relevant scores from envifit
env.scores.FloristicSurvey <- cbind(env.scores.FloristicSurvey, env.variables = rownames(env.scores.FloristicSurvey)) #and then gives them their names

# function for ellipsess - just run this, is used later
#taken from the excellent stackoverflow Q+A: http://stackoverflow.com/questions/13794419/plotting-ordiellipse-function-from-vegan-package-onto-nmds-plot-created-in-ggplo
veganCovEllipse <- function (cov, center = c(0, 0), scale = 1, npoints = 100) 
{
  theta <- (0:npoints) * 2 * pi/npoints
  Circle <- cbind(cos(theta), sin(theta))
  t(center + scale * t(Circle %*% chol(cov)))
}

#data for ellipse, use GM coverage
df_ell.FSurvey.GM_coverage <- data.frame() #sets up a data frame before running the function.
for(g in levels(FloristicSurvey.NMDS.data$GM_Coverage)){
  df_ell.FSurvey.GM_coverage <- rbind(df_ell.FSurvey.GM_coverage, cbind(as.data.frame(with(FloristicSurvey.NMDS.data [FloristicSurvey.NMDS.data$GM_Coverage==g,],
                                                                                   veganCovEllipse(cov.wt(cbind(NMDS1,NMDS2),wt=rep(1/length(NMDS1),length(NMDS1)))$cov,center=c(mean(NMDS1),mean(NMDS2)))))
                                                                ,GM_coverage=g))
}

# data for labelling the ellipse
NMDS.mean.FloristicSurvey=aggregate(FloristicSurvey.NMDS.data[ ,c("NMDS1", "NMDS2")], 
                         list(group = FloristicSurvey.NMDS.data$GM_Coverage), mean)

## finally plotting.
mult <- 1 #multiplier for the arrows and text for envfit below. You can change this and then rerun the plot command.
NMDS_of_Floristic_Composition<-ggplot(data = FloristicSurvey.NMDS.data, aes(y = NMDS2, x = NMDS1))+ 
    geom_path(data = df_ell.FSurvey.GM_coverage, aes(x = NMDS1, y = NMDS2, group = df_ell.FSurvey.GM_coverage$GM_coverage, color=df_ell.FSurvey.GM_coverage$GM_coverage))+ 
    geom_point( aes(color = FloristicSurvey.NMDS.data$GM_Coverage), size = 1)+ 
    scale_color_manual(values = c(14,5,19,2))+ 
    coord_cartesian(xlim = c(-.5,.5))+
  theme_simple()+ guides(color=guide_legend("Garlic Mustard Coverage"))+
  ggtitle("NMDS of Floristic Composition \n in a Garlic Mustard Population")+
  theme_bw()+
  theme(legend.title=element_blank(),plot.title = element_text(hjust = 0.5,face="bold", size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.title.x = element_text(size=18),axis.title.y = element_text(size=18),axis.text.y = element_text(size=10),panel.border = element_rect(colour = "black"),strip.background = element_rect(colour = "black",fill="white"),strip.text.x = element_text(size = 12))+scale_color_manual(values=c("green3"," blue3","orange3","red3"))
NMDS_of_Floristic_Composition
ggsave(file="NMDS_of_Floristic_Composition.eps", plot=NMDS_of_Floristic_Composition, width=10, height=8)
```


### RDA
species comp ~ GMcov * pop + soil characteristics inside and outside as covariates? 
```{r}

species<-names(FloristicSurvey[4:(length(FloristicSurvey))])
SpeciesGMCorrelation <- data.frame(matrix(ncol = 3, nrow = 0))
names(SpeciesGMCorrelation)<-c("Species", "PValue","signif")

for(i in 4:(length(FloristicSurvey))){
  SpeciesGMCorrelation[i-3,1]<-names(FloristicSurvey[i])
  SpeciesGMCorrelation[i-3,2]<-summary(glm(FloristicSurvey[,i]~GM_Coverage, data=FloristicSurvey, family = binomial))$coefficients[8]
}
for(i in 1:length(species)) if( SpeciesGMCorrelation[i,2] <= 0.05){
  SpeciesGMCorrelation[i,3]<-c("TRUE")
}else{
  SpeciesGMCorrelation[i,3]<-c("FALSE")
  }
length(SpeciesGMCorrelation$signif[SpeciesGMCorrelation[,3]==TRUE])/length(SpeciesGMCorrelation$signif)*100
SpeciesGMCorrelation$Species[SpeciesGMCorrelation[,3]==TRUE]


# Redundancy analysis
sp.comp <- FloristicSurvey[,4:(length(FloristicSurvey)-1)]
var <- FloristicSurvey[,c(1:3,length(FloristicSurvey))]
var$Quadrat <- as.character(var$Quadrat)
for(i in 1:length(var$Quadrat))if(var$Population[i] == "7"){
  var$Quadrat[i]<-paste("7",var$Quadrat[i],sep="")
}else if(var$Population[i] == "3"){
  var$Quadrat[i]<-paste("3",var$Quadrat[i],sep="")
}else if(var$Population[i] == "14"){
  var$Quadrat[i]<-paste("14",var$Quadrat[i],sep="")
}else if(var$Population[i] == "13"){
  var$Quadrat[i]<-paste("13",var$Quadrat[i],sep="")
}else if(var$Population[i] == "1"){
  var$Quadrat[i]<-paste("1",var$Quadrat[i],sep="")
}

var$Population <- as.factor(var$Population)
var$GM_Coverage<-as.numeric(var$GM_Coverage)
sp.comp.hell<-decostand(sp.comp,method="hellinger")

formulaRDA <- rda(sp.comp.hell ~ GM_Coverage + Population , data=var)

head(summary(formulaRDA))
RsquareAdj(formulaRDA)
coef(formulaRDA)
scor = scores(formulaRDA, display=c("sp", "cn", "bp"), scaling=2) 
 

anova.cca(formulaRDA,step=1000)
anova.cca(formulaRDA,by="terms", step=1000)




# numeric centroids
numeric_centroids <- data.frame(scor$centroids)
numeric_centroids
str(numeric_centroids)
numeric_centroids$Population <- rownames(numeric_centroids)
numeric_centroids
 
# testing it out
ggplot(numeric_centroids, aes(x = RDA1, y = RDA2))+
  geom_text(aes(label = Population))+ # label tells geom_text which text you want to plot
  ylim(-1,1)+ #NB note that this is a convenience wrapper and may cut data out of your plot
  xlim(-1,1) #important if you are calculating stats in the plot - these will be excluded
 
# species
species_centroids <- data.frame(scor$species)
species_centroids
species_centroids$species_names <- rownames(species_centroids) # you can also put label = rownames() etc in the ggplot code. But sometimes you may want it in a column for later
 
ggplot(numeric_centroids, aes(x = RDA1, y = RDA2))+
  geom_text(aes(label = Population))+
  geom_text(data = species_centroids, aes(label = species_names),
            colour = "orange")+
  ylim(-1,1)+
  xlim(-1,1)
 
# arrows
continuous_arrows <- data.frame(scor$biplot)
continuous_arrows
continuous_arrows$manure_class <- rownames(continuous_arrows) #turning rownames into a variable
continuous_arrows
 
site_scores <- data.frame(scores(formulaRDA)$sites)
site_scores$site_num <- var$Quadrat
site_scores$coverage<-var$GM_Coverage_category
 

RDA_plot <- ggplot(numeric_centroids, aes(x = RDA1, y = RDA2))+
   geom_point(data = site_scores, aes(x = RDA1, y = RDA2,  color=coverage),
             size = 3)+
   coord_cartesian(x = c(-1, 1), y = c(-1,1.2))+
   geom_segment(data = continuous_arrows,
                aes(x = 0, xend = mult * RDA1,
                    y = 0, yend = mult * RDA2),
                arrow = arrow(length = unit(0.25, "cm")), colour = "grey") + #grid is required for arrow to work.
   geom_text(data = continuous_arrows,
             aes(x= (mult + mult/10) * RDA1, y = (mult + mult/10) * RDA2, 
                 label = manure_class), 
             size = 5,
             hjust = 0.5)+
   geom_text(aes(label = Population))+ theme_bw()
RDA_plot
ggsave(file="RDA_plot.eps", plot=RDA_plot, width=10, height=8)

```


# Soil Characteristics

```{r, Soil Characteristics}
Soil_characteristics$Location<-as.factor(Soil_characteristics$Location)
GLmodel_soil <- glm(Location ~Agg_stability*C_percent*N_percent,family=binomial(link='logit'),data=Soil_characteristics)
summary(GLmodel_soil)

Soil_characteristics2 <- data.frame(Soil_characteristics$Population, Soil_characteristics$Location, log(Soil_characteristics$pH), log(Soil_characteristics$Agg_stability), log(Soil_characteristics$C_percent), log(Soil_characteristics$N_percent))
Soil_characteristics2<-rename(Soil_characteristics2, c("Soil_characteristics.Population"="Population", "Soil_characteristics.Location"="Location", "log.Soil_characteristics.pH."="pH", "log.Soil_characteristics.Agg_stability."="Agg_stability", "log.Soil_characteristics.C_percent."="Percent","log.Soil_characteristics.N_percent."="Percent" ))
df2 <- reshape2::melt(Soil_characteristics2, id.var=c("Population","Location"))
df2 <- rename(df2, c("value"="Log_value"))


Agg_stability_plot<-ggplot(Soil_characteristics, aes(Location,Agg_stability,fill=Location))+ geom_boxplot() +
  theme_bw()+
  theme(legend.title=element_blank(),plot.title = element_text(hjust = 0.5,face="bold", size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.title.x = element_text(size=18),axis.title.y = element_text(size=18),axis.text.y = element_text(size=10),panel.border = element_rect(colour = "black"),strip.background = element_rect(colour = "black",fill="white"),strip.text.x = element_text(size = 12))+scale_fill_manual(values=c("red3","blue3"))

ph_plot<-ggplot(Soil_characteristics, aes(Location,pH,fill=Location))+ geom_boxplot() +
  theme_bw()+
  theme(legend.title=element_blank(),plot.title = element_text(hjust = 0.5,face="bold", size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.title.x = element_text(size=18),axis.title.y = element_text(size=18),axis.text.y = element_text(size=10),panel.border = element_rect(colour = "black"),strip.background = element_rect(colour = "black",fill="white"),strip.text.x = element_text(size = 12)) + scale_fill_manual(values=c("red3","blue3"))

C_percent_plot<-ggplot(Soil_characteristics, aes(Location,C_percent,fill=Location))+ geom_boxplot() +
  theme_bw()+
  theme(legend.title=element_blank(),plot.title = element_text(hjust = 0.5,face="bold", size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.title.x = element_text(size=18),axis.title.y = element_text(size=18),axis.text.y = element_text(size=10),panel.border = element_rect(colour = "black"),strip.background = element_rect(colour = "black",fill="white"),strip.text.x = element_text(size = 12)) + scale_fill_manual(values=c("red3","blue3"))

N_percent_plot<-ggplot(Soil_characteristics, aes(Location,N_percent,fill=Location))+ geom_boxplot() +
  theme_bw()+
  theme(legend.title=element_blank(),plot.title = element_text(hjust = 0.5,face="bold", size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.title.x = element_text(size=18),axis.title.y = element_text(size=18),axis.text.y = element_text(size=10),panel.border = element_rect(colour = "black"),strip.background = element_rect(colour = "black",fill="white"),strip.text.x = element_text(size = 12))+scale_fill_manual(values=c("red3","blue3"))

edaphic_soil_qualities_plot<-grid_arrange_shared_legend(Agg_stability_plot, ph_plot,C_percent_plot, N_percent_plot)
ggsave(file="edaphic_soil_qualities_plot.eps", plot=edaphic_soil_qualities_plot, width=10, height=8)

Soil_characteristics$Population<-as.factor(Soil_characteristics$Population)

GLMER_soil <- glmer(Location~scale(Agg_stability)*scale(C_percent)*scale(N_percent)+(1|Population),family=binomial(link='logit'),data=Soil_characteristics)
residfit(GLMER_soil)
scaleloc(GLMER_soil)

pr<-resid(GLMER_soil, type='pearson')
n<-nrow(Soil_characteristics)
c<-length(coef(GLMER_soil))
(Disp<-sum(pr^2)/(n-c))

summary(GLMER_soil)
options(na.action = "na.fail")
dredge(GLMER_soil) 
# A model with nothing is best...
```


LDA differs from RDA and CCA in that the response variable is a grouping of the
sites. This grouping may have been obtained by clustering the sites on the basis of
a data set, or it may represent an ecological hypothesis. LDA tries to determine to what extent an independent set of quantitative variables can explain this grouping.
```{r soil LDA}
var<-Soil_characteristics[,c(1,2)]
Y<-Soil_characteristics[,-c(1,2,5)]
var$Population<-as.factor(var$Population)
Location<-as.factor(var$Location)
Y$Sample <-paste(var$Population,var$Location) 
rownames(Y)<-Y$Sample
Y$Sample<-NULL

covar_cor = cor(Y)
corrplot.mixed(covar_cor, upper = "ellipse", lower = "number")

Nutrient_PCA<-dudi.pca(df = Y[, c(3, 4)], scannf = FALSE, nf = 1)
Nutrient_PCA$co
Nutrient_PCA$eig/sum(Nutrient_PCA$eig)
Y$Nutrient_PC1 = Nutrient_PCA$li[,1]

Y<-Y[,c(1,2,5)]

Y.d1 <-dist(Y)
Y.MHV<-betadisper(Y.d1,var$Location)
permutest(Y.MHV) # no significant difference in dispersion between groups


formulaLDA <- lda(var$Location ~ Agg_stability + Nutrient_PC1 + pH, data=Y)
summary(formulaLDA)
formulaLDA$means
scalvec<-data.frame(formulaLDA$scaling)
LDAval <- data.frame(predict(formulaLDA)$x)
anova(lm(LDAval$LD1~var$Location))
DF<-cbind(LDAval$LD1,data.frame(var$Location))
colnames(DF)<-c("LDAval","Location")
SoilLDAplot<-ggplot(DF, aes(LDAval, fill = Location)) + geom_density(alpha = 0.2)+
  ggtitle("Linear Discriminant analysis of Soil characteristics \n in and out of A. petiolata invasion")+
  theme_bw()+
  theme(legend.title=element_blank(),plot.title = element_text(hjust = 0.5,face="bold", size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.title.x = element_text(size=18),axis.title.y = element_text(size=18),axis.text.y = element_text(size=10),panel.border = element_rect(colour = "black"),strip.background = element_rect(colour = "black",fill="white"),strip.text.x = element_text(size = 12))+scale_fill_manual(values=c("red3","blue3"))
SoilLDAplot
ggsave(file="SoilLDAplot.pdf", plot=SoilLDAplot, width=10, height=8)


```

# Histology data Analysis

# Histology Data exploration

Calculate plant-level Mycchorizae, pathogens and herbivory:


```{r}
# Fix column characteristics for plotting and analysis
fdata$indiv2<-as.factor(fdata$indiv2)
fdata$Mycorrhiza<-as.numeric(paste(fdata$Mycorrhiza))
fdata$Lesion<-as.numeric(paste(fdata$Lesion))
fdata$Herbivory<-as.numeric(paste(fdata$Herbivory))
pct<-function(x){
  sum(x)/100
}

# Calculate plant-level averages
fdat_ind<-aggregate(fdata[,c("Mycorrhiza","Lesion","Herbivory")],by=list(indiv2=fdata$indiv2,pop=fdata$pop,loc=fdata$loc,species=fdata$species), FUN=pct)

```


#### Simple linear model visualization:


```{r}
## Mycorrhiza model (NOTE: No loc*species because not all species present in all populations)
base.Myc<-lmer(Mycorrhiza~species+loc+species:loc+(1|pop)+(1|pop:loc),data=fdat_ind)
noint.Myc<-lmer(Mycorrhiza~species+loc+(1|pop)+(1|pop:loc),data=fdat_ind)
anova(base.Myc,noint.Myc)
base.Myc ## Inspect coefficients

Myc_location_species_plot <- ggplot(fdat_ind,aes(loc,Mycorrhiza, fill=loc))+geom_boxplot()+facet_wrap(~species)+
  xlab("Plant Species")+ylab("Mycorrhizal \nColonization")+
  ggtitle("Species Mycorrhizal Colonization \n in and out of Garlic Mustard")+
  theme_bw()+
  theme(legend.title=element_blank(),plot.title = element_text(hjust = 0.5,face="bold", size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.title.x = element_text(size=18),axis.title.y = element_text(size=18),axis.text.y = element_text(size=10),panel.border = element_rect(colour = "black"),strip.background = element_rect(colour = "black",fill="white"),strip.text.x = element_text(size = 18))+scale_fill_manual(values=c("light blue","forest green"))
Myc_location_species_plot
ggsave(file="Myc_location_species_plot.pdf", plot=Myc_location_species_plot, width=10, height=8)

Lesion_location_species_plot <- ggplot(fdat_ind,aes(loc,Lesion,fill=loc))+geom_boxplot()+facet_wrap(~species)+
  xlab("Plant Species")+ylab("Lesion")+
  ggtitle("Species Lesions \n in and out of Garlic Mustard")+
  theme_bw()+
  theme(legend.title=element_blank(),plot.title = element_text(hjust = 0.5,face="bold", size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.title.x = element_text(size=18),axis.title.y = element_text(size=18),axis.text.y = element_text(size=10),panel.border = element_rect(colour = "black"),strip.background = element_rect(colour = "black",fill="white"),strip.text.x = element_text(size = 18))+scale_fill_manual(values=c("red3","blue3"))
Lesion_location_species_plot
ggsave(file="Lesion_location_species_plot.pdf", plot=Lesion_location_species_plot, width=10, height=8)

Myc_location_population_plot<-ggplot(fdat_ind,aes(loc,Mycorrhiza,fill=loc))+geom_boxplot()+facet_wrap(~pop)+
  xlab("Population")+ylab("Mycorrhizal \nColonization")+
  ggtitle("Mycorrhizal Colonization \n in and out of Garlic Mustard Population")+
  theme_bw()+
  theme(legend.title=element_blank(),plot.title = element_text(hjust = 0.5,face="bold", size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.title.x = element_text(size=18),axis.title.y = element_text(size=18),axis.text.y = element_text(size=10),panel.border = element_rect(colour = "black"),strip.background = element_rect(colour = "black",fill="white"),strip.text.x = element_text(size = 18))+scale_fill_manual(values=c("red3","blue3"))
Myc_location_population_plot
ggsave(file="Myc_location_population_plot.pdf", plot=Myc_location_population_plot, width=10, height=8)
```

**Mycorrhia model results**

1. Mycorrhiza colonization is significantly higher outside patches of A. petiolata than inside
  2a. Species vary in Mycorrhiza colonization, with highest colonization in SC and others relatively similar. 
  2b. Effect of A. petiolata on Mycorrhiza colonization differs among species, with more pronounced effects for GR and MR, and will little effect for GA
  3. Effect of A. petiolata on Mycorrhiza colonization varies by population, but not as strongly as among species


```{r}
## Mycorrhiza model (NOTE: No loc*species because not all species present in all populations)
base.Les<-lmer(Lesion~Mycorrhiza*species*loc+(1|pop/loc),data=fdat_ind)
norint.Les<-lmer(Lesion~Mycorrhiza*species*loc+(1|pop),data=fdat_ind)
anova(base.Les,norint.Les)
norint.Les # inspect coefficients

Les2<-lmer(Lesion~Mycorrhiza*species*loc-Mycorrhiza:species:loc+(1|pop),data=fdat_ind)
anova(norint.Les,Les2)

Les3a<-lmer(Lesion~Mycorrhiza*species+Mycorrhiza*loc+(1|pop),data=fdat_ind)
Les3b<-lmer(Lesion~Mycorrhiza*species+species*loc+(1|pop),data=fdat_ind)
Les3c<-lmer(Lesion~species*loc+Mycorrhiza*loc+(1|pop),data=fdat_ind)
anova(norint.Les,Les3a) # TEST species*loc 
anova(norint.Les,Les3b) # TEST Myc*loc 
anova(norint.Les,Les3c) # TEST Myc*species


Myc_vs_Lesion<-ggplot(fdat_ind,aes(Mycorrhiza,Lesion))+facet_wrap(~species)+
  geom_point(aes(col=loc))+theme_simple()+geom_smooth(method="lm",colour="black")+
  xlab("Mycorrhizal \nColonization")+ylab("Lesion \nMeasurement")+
  ggtitle("Effect of Mycorrhiza on Lesions \n in and out of Garlic Mustard per Species")+
  theme_bw()+
  theme(legend.title=element_blank(),plot.title = element_text(hjust = 0.5,face="bold", size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.title.x = element_text(size=18),axis.title.y = element_text(size=18),axis.text.y = element_text(size=10),panel.border = element_rect(colour = "black"),strip.background = element_rect(colour = "black",fill="white"),strip.text.x = element_text(size = 18))+scale_color_manual(values=c("red3","blue3"))
Myc_vs_Lesion
ggsave(file="Myc_vs_Lesion.eps", plot=Myc_vs_Lesion, width=10, height=8)
```

** Lesions model results**

  1. Root lesions increase with mycorrhiza colonization, contrary to predictions
  2. Effect of Mycorrhiza on Lesions depends strongly on species (Myc*species interactions)


## Hypothesis 1: Lesion ~ Mycorriza

GIVEN THE NEW ANALYSIS ABOVE, THIS ISN'T WORTHWILE BECAUSE THERE IS NO SIGNIFICANT Myc:species:loc

```{r}
# calculating the r
indivCODE <- unique(fdata$indiv2)
dfcorr <-data.frame(indivCODE=c(0),r=c(0))
for (i in 1:length(indivCODE)){
  dat1<-NULL
  dat1<-filter(fdata, fdata$indiv2==indivCODE[i])
  dfcorr[i,1] <- indivCODE[i]
  dfcorr[i,2] <- cor(as.numeric(dat1$Mycorrhiza),as.numeric(dat1$Lesion))
}
dfcorr %>% drop_na()->dfcorr
```


###Co-occurence data

```{r Co-occurence model using corr, eval=FALSE}
#Normal?
car::qqp(dfcorr$r, "norm")
shapiro.test(dfcorr$r)
hist(dfcorr$r)
# Cannot be normal because it is only between -1 and 1 and our mean is at 0.
descdist(dfcorr$r, discrete = FALSE, boot = 500)

# weibull when transformed to be positive?
dfcorr$r.t <- dfcorr$r+1
fit.weibull <- fitdist(dfcorr$r.t, "weibull")
car::qqp(dfcorr$r.t, "weibull", shape = fit.weibull$estimate[[1]])

dfcorr$pop <- gsub("^([0-9]+)[I,O][A-Z]+.*","\\1",dfcorr$indivCODE)
dfcorr$location <- gsub("^[0-9]+([I,O])[A-Z]+.*","\\1",dfcorr$indivCODE)
dfcorr$species <- sub("^[0-9]+[I,O]([A-Z]+).*","\\1",dfcorr$indivCODE)
dfcorr$location <- as.factor(dfcorr$location)
dfcorr$species <- as.factor(dfcorr$species)
dfcorr$pop <- as.factor(dfcorr$pop)

meanR<-mean(dfcorr$r)
SEMR<-sd(dfcorr$r)/sqrt(length(dfcorr$r))
UCI<- meanR+SEMR*1.96
LCI<- meanR-SEMR*1.96
mean(filter(dfcorr, dfcorr$location=="I")$r)
mean(filter(dfcorr, dfcorr$location=="O")$r)


baysian_corrGLMM <- brm(r.t ~ location * species + (1|pop), data=dfcorr, family = weibull(link="log"), control = list(adapt_delta = 0.9))
baysian_corrGLMM2 <- brm(r.t ~ location + species + (1|pop), data=dfcorr, family = weibull(link="log"), control = list(adapt_delta = 0.9))
baysian_corrGLMM3 <- brm(r.t ~ location + (1|pop), data=dfcorr, family = weibull(link="log"), control = list(adapt_delta = 0.9))
baysian_corrGLMM_NULL <- brm(r.t ~ 1 + (1|pop), data=dfcorr, family = weibull(link="log"), control = list(adapt_delta = 0.9))

waic.BCG_1<-waic(baysian_corrGLMM)
waic.BCG_2<-waic(baysian_corrGLMM2)
waic.BCG_3<-waic(baysian_corrGLMM3)
waic.BCG_NULL<-waic(baysian_corrGLMM_NULL)
compare(waic.BCG_1,waic.BCG_2) #positive means second is better
compare(waic.BCG_2,waic.BCG_3) #negative means first is better
compare(waic.BCG_2,waic.BCG_NULL) #negative means first is better
summary(baysian_corrGLMM2)
bayes_R2(baysian_corrGLMM2)


ggplot(dfcorr, aes(y=r,x=location))+geom_boxplot()+theme_simple()
ggplot(dfcorr, aes(y=r,x=species))+geom_boxplot()+theme_simple()

```

###Totals data

```{r Totals model}

# model 
GLMMmyc_lesion <- glmer(binlesion ~ None.Myc * species + (1 | pop) , data = ndatas,family = binomial(link = "logit"))
summary(GLMMmyc_lesion)

options(na.action="na.fail")
dredge(GLMMmyc_lesion)
r.squaredGLMM(GLMMmyc_lesion)
# will need to change this ASAP

ggplot(data = ndata,aes(x = 1-None.Myc, y = 100-None.Path))+
  stat_summary(fun.y=mean, geom="point")+
  geom_smooth(method = "lm")+
  geom_point()+
  theme_simple()+
  facet_wrap("species")+
  labs(x = "Mycorrhizal colonization", y="Lesions")
```

## Hypothesis 2: Mycorrhiza & Lesion ~ invasion

### Does location impact the effect of myc on lesion? 

```{r location interaction with mycorrhiza and lesion}
GLMMmyc_lesion_loc <- glmer(binlesion ~ None.Myc * location * species + (1 | pop), data = ndatas, family = binomial(link = "logit"))
summary(GLMMmyc_lesion_loc)


emm<-emmeans(GLMMmyc_lesion_loc, list(~None.Myc| species | location, ~None.Myc| location), type = "response" )
summary(emm)


ggplot(data = ndata,aes(x = 1-None.Myc, y = 100-None.Path))+
  geom_smooth(method = "lm")+
  geom_point(aes(color=location))+
  theme_simple()+
  facet_wrap("species")+
  labs(x = "Mycorrhizal colonization", y="Lesions")


pca <- prcomp(ndata[,c(5,9)])
location <- ndata[,13]
g <- ggbiplot(pca, obs.scale = 1, var.scale = 1, 
                groups = location, ellipse = TRUE, 
                circle = TRUE)
g <- g + scale_color_discrete(name = '')
g <- g + theme(legend.direction = 'horizontal', 
                 legend.position = 'top')
print(g)
```

### Does location impact lesion alone?

```{r location on lesion}
glmerLESION_disp <- glmer (binlesion ~ location * species + (1|pop) + (1|indiv), data = ndatas, family = binomial(link="logit"))
summary(glmerLESION_disp)
options(na.action="na.fail")
dredge(glmerLESION_disp)
r.squaredGLMM(glmerLESION_disp)


ggplot(aes(x = location, y = 100-None.Path, color=location), data=ndata)+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  facet_wrap("species")+
  theme_simple()
```

### Does location impact mycorrhiza alone?


```{r location on mycorrhiza}
glmerMYC_disp <- glmer (binmycorr ~ location * species + (1|pop) + (1|indiv), data = ndata, family = binomial(link="logit"))
summary(glmerMYC_disp)
options(na.action="na.fail")
dredge(glmerMYC_disp)
r.squaredGLMM(glmerMYC_disp)

ggplot(aes(x = location, y = 100-None.Myc, color=location), data=ndata)+
  geom_boxplot()+
  geom_jitter(width=0.1)+
  facet_wrap("species")+
  theme_simple()

```

## Hypothesis 3 + 4: Lesion ~ Mycorriza * invasion

```{r Hypothesis 3}

ggplot(data = ndata,aes(x = 1-None.Myc, y = 100-None.Path, color=location))+
  geom_smooth(method = "lm")+
  geom_point()+
  theme_simple()+
  facet_wrap("species")+
  labs(x = "Mycorrhizal colonization", y="Lesions")


Myc_vs_Lesion_plot<-ggplot(data = ndata,aes(x = 1-None.Myc, y = 100-None.Path, color=location))+
  geom_smooth(method = "lm")+
  geom_point()+
  theme_simple()+
  labs(x = "Mycorrhizal colonization", y="Lesions")+
  xlab("Mycorrhizal \nColonization")+ylab("Lesion \nMeasurement")+
  ggtitle("Effect of Mycorrhiza on Lesions \n in and out of Garlic Mustard")+
  theme_bw()+
  theme(legend.title=element_blank(),plot.title = element_text(hjust = 0.5,face="bold", size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.title.x = element_text(size=18),axis.title.y = element_text(size=18),axis.text.y = element_text(size=10),panel.border = element_rect(colour = "black"),strip.background = element_rect(colour = "black",fill="white"),strip.text.x = element_text(size = 18))+scale_color_manual(values=c("red3","blue3"))
Myc_vs_Lesion_plot
ggsave(file="Myc_vs_Lesion_plot.eps", plot=Myc_vs_Lesion_plot, width=10, height=8)
```

## Bring things together

```{r soil lesion~myc}
Soil_characteristics$Location<-as.character(Soil_characteristics$Location)
for(i in 1:length(Soil_characteristics$Location))if(Soil_characteristics[i,2]=="in"){
   Soil_characteristics[i,2]<-"I"
}else{
  Soil_characteristics[i,2]<-"O"
}
Soil_characteristics$Location<-as.factor(Soil_characteristics$Location)  
names(Soil_characteristics)[1:2]<-c("pop","location")

fulldata <- merge(Soil_characteristics, ndata, by=c("pop","location"))
names(Root_size)[1]<-"indiv"
fulldata <- merge(fulldata, Root_size, by=c("indiv","location","pop","species"))
for(i in 1:length(fulldata$indiv)){
fulldata$mean_rootsize[i]<-(sum(fulldata[i,20:29])/length(fulldata[,20:29]))
}
fulldata<-fulldata[,-c(20:29)]

binlesionF<-cbind(fulldata$None.Path,100-fulldata$None.Path)
binmycorrF<-cbind(fulldata$None.Myc,100-fulldata$None.Myc)
binherbivoryF<-cbind(fulldata$None.Herb,100-fulldata$None.Herb)


fulldata$pop<-as.factor(fulldata$pop)
fulldata$Mycorrhiza<-100-fulldata$None.Myc
fulldata$Lesion<-100-fulldata$None.Path
# model myc_lesion 
hist(fulldata$Lesion)
shapiro.test(fulldata$Lesion)
mod1 <- glmmadmb(Lesion ~ Mycorrhiza + scale(mean_rootsize) + species + 
                    scale(pH) + scale(Agg_stability) + scale(N_percent) +
                    scale(C_percent) + (1 | pop) +
                          Mycorrhiza:N_percent + Mycorrhiza:scale(mean_rootsize) +
                          Mycorrhiza:species + Mycorrhiza:scale(pH) +
                          Mycorrhiza:scale(Agg_stability)+Mycorrhiza:C_percent,
                  data = fulldata,family = "poisson")
summary(mod1)
residfit(mod1)
scaleloc(mod1)

pr<-resid(mod1, type='pearson')
n<-nrow(fulldata)
c<-length(coef(mod1))
(Disp<-sum(pr^2)/(n-c))

mod10 <- glmmadmb(Lesion ~  Mycorrhiza + scale(mean_rootsize) + species + 
                    scale(pH) + scale(Agg_stability) + scale(N_percent) +
                    scale(C_percent) + (1 | pop) +
                          Mycorrhiza:N_percent + Mycorrhiza:scale(mean_rootsize) +
                          Mycorrhiza:species + Mycorrhiza:scale(pH) +
                          Mycorrhiza:scale(Agg_stability)+Mycorrhiza:C_percent,
                  data = fulldata,family = "nbinom1")

mod11 <- glmmadmb(binlesionF ~ Mycorrhiza + scale(mean_rootsize) + species + 
                    scale(pH) + scale(Agg_stability) + scale(N_percent) +
                    scale(C_percent) + (1 | pop) +
                          Mycorrhiza:N_percent + Mycorrhiza:scale(mean_rootsize) +
                          Mycorrhiza:species + Mycorrhiza:scale(pH) +
                          Mycorrhiza:scale(Agg_stability)+Mycorrhiza:C_percent,
                  data = fulldata,family = "binomial")

ICtab(mod1, mod10, mod11, type='AICc')


#ploting the residuals of mycorrhizal on lesions
hist(fulldata$Mycorrhiza)
mod1.2<-glm.nb(Mycorrhiza ~ scale(mean_rootsize) + species + 
                    scale(pH) + scale(Agg_stability) + scale(N_percent) +
                    scale(C_percent) +
                          Mycorrhiza:N_percent + Mycorrhiza:scale(mean_rootsize) +
                          Mycorrhiza:species + Mycorrhiza:scale(pH) +
                          Mycorrhiza:scale(Agg_stability)+Mycorrhiza:C_percent,
               data = fulldata)
residfit(mod1.2)
scaleloc(mod1.2)

pr<-resid(mod1.2, type='pearson')
n<-nrow(fulldata)
c<-length(coef(mod1.2))
(Disp<-sum(pr^2)/(n-c))

var<-fulldata[,c(5,6,8,9,20,21,22)]
covar_cor = cor(var)
corrplot.mixed(covar_cor, upper = "ellipse", lower = "number")

Nutrient_PCA = dudi.pca(df = var[, c(3, 4)], scannf = FALSE, nf = 1)
Nutrient_PCA$co
Nutrient_PCA$eig/sum(Nutrient_PCA$eig)
fulldata$Nutrient_PC1 = Nutrient_PCA$li[,1]

mod10 <- glmmadmb(Lesion ~ Mycorrhiza + location + scale(mean_rootsize) + species + 
                                   scale(pH)+ scale(Agg_stability) + Nutrient_PC1 + 
                                   (1 | pop)+
                                   Mycorrhiza:Nutrient_PC1 + Mycorrhiza:scale(mean_rootsize) +
                                   Mycorrhiza:species + Mycorrhiza:scale(pH) +
                                   Mycorrhiza:scale(Agg_stability)+ Mycorrhiza:location, 
                                 data = fulldata,family = "nbinom1")

mod10.2 <- glmmadmb(Lesion ~ Mycorrhiza + scale(mean_rootsize) + species + 
                                    scale(pH)+ scale(Agg_stability) + Nutrient_PC1 + 
                                    (1 | pop)+
                                    Mycorrhiza:Nutrient_PC1 + Mycorrhiza:scale(mean_rootsize) +
                                    Mycorrhiza:species + Mycorrhiza:scale(pH) +
                                    Mycorrhiza:scale(Agg_stability)+ Mycorrhiza:location, 
                                  data = fulldata,family = "nbinom1")



mod10.3 <- glmmadmb(Lesion ~ Mycorrhiza + scale(mean_rootsize) + species + 
                      scale(pH)+ scale(Agg_stability) + Nutrient_PC1 + 
                      (1 | pop)+
                      Mycorrhiza:Nutrient_PC1 + Mycorrhiza:scale(mean_rootsize) +
                      Mycorrhiza:species + Mycorrhiza:scale(pH) +
                      Mycorrhiza:scale(Agg_stability), 
                    data = fulldata,family = "nbinom1")


mod10.4 <- glmmadmb(Lesion ~ scale(mean_rootsize) + species + 
                          scale(pH)+ scale(Agg_stability) + Nutrient_PC1 + 
                          (1 | pop)+
                          Mycorrhiza:Nutrient_PC1 + Mycorrhiza:scale(mean_rootsize) +
                          Mycorrhiza:species + Mycorrhiza:scale(pH) +
                          Mycorrhiza:scale(Agg_stability), 
                        data = fulldata,family = "nbinom1")

ICtab(mod10, mod10.2, mod10.3, mod10.4) # mycorrhiza or not should not be discounted. delta = 2.


mod10.5 <- glmmadmb(Lesion ~ Mycorrhiza + scale(mean_rootsize) + species + 
                      scale(Agg_stability) + Nutrient_PC1 + 
                      (1 | pop)+
                      Mycorrhiza:Nutrient_PC1 + Mycorrhiza:scale(mean_rootsize) +
                      Mycorrhiza:species + Mycorrhiza:scale(pH) +
                      Mycorrhiza:scale(Agg_stability), 
                    data = fulldata,family = "nbinom1")

ICtab(mod10.3,mod10.5)

mod10.6 <- glmmadmb(Lesion ~ Mycorrhiza + scale(mean_rootsize) + species + 
                      Nutrient_PC1 + 
                      (1 | pop)+
                      Mycorrhiza:Nutrient_PC1 + Mycorrhiza:scale(mean_rootsize) +
                      Mycorrhiza:species + Mycorrhiza:scale(pH) +
                      Mycorrhiza:scale(Agg_stability), 
                    data = fulldata,family = "nbinom1")

ICtab(mod10.6,mod10.5)

mod10.7 <- glmmadmb(Lesion ~ Mycorrhiza + scale(mean_rootsize) + species + 
                      Nutrient_PC1 + 
                      (1 | pop)+
                      Mycorrhiza:Nutrient_PC1 + Mycorrhiza:scale(mean_rootsize) +
                      Mycorrhiza:species + 
                      Mycorrhiza:scale(Agg_stability), 
                    data = fulldata,family = "nbinom1")

ICtab(mod10.6,mod10.7)


mod10.8 <- glmmadmb(Lesion ~ Mycorrhiza + scale(mean_rootsize) + species + 
                      Nutrient_PC1 + 
                      (1 | pop)+
                      Mycorrhiza:Nutrient_PC1 + Mycorrhiza:scale(mean_rootsize) +
                      Mycorrhiza:species + Mycorrhiza:scale(pH),
                    data = fulldata,family = "nbinom1")
ICtab(mod10.6,mod10.8)


mod10.9 <- glmmadmb(Lesion ~ Mycorrhiza + scale(mean_rootsize) + species+
                      (1 | pop)+
                      Mycorrhiza:Nutrient_PC1 + Mycorrhiza:scale(mean_rootsize) +
                      Mycorrhiza:species + Mycorrhiza:scale(pH) +
                      Mycorrhiza:scale(Agg_stability), 
                    data = fulldata,family = "nbinom1")
ICtab(mod10.9,mod10.6)

mod10.10 <- glmmadmb(Lesion ~ Mycorrhiza + scale(mean_rootsize) + species + 
                      Nutrient_PC1 + 
                      (1 | pop)+
                      Mycorrhiza:scale(mean_rootsize) +
                      Mycorrhiza:species + Mycorrhiza:scale(pH) +
                      Mycorrhiza:scale(Agg_stability), 
                    data = fulldata,family = "nbinom1")

ICtab(mod10.10,mod10.6)

pr<-resid(mod10.6, type='pearson')
n<-nrow(fulldata)
c<-length(coef(mod10.6))
(Disp<-sum(pr^2)/(n-c))

summary(mod10.6)
data.frame(coef(mod10.6))
confint(mod10.6)

pdf(file="regressioncoefficients_lesionvsMyc.pdf", width=10, height=8)
coefplot2(mod10.6)
dev.off()

effect(mod = mod10.Colin, "Mycorrhiza")
```
```{r Model based figure myc VS lesion in soil}
mod10.Colin.NM <- glmmadmb(Lesion ~ scale(mean_rootsize) + species + 
                          scale(pH)+ scale(Agg_stability) + Nutrient_PC1 + (1 | pop)+
                          Mycorrhiza:Nutrient_PC1 + Mycorrhiza:scale(mean_rootsize) +
                          Mycorrhiza:species + Mycorrhiza:scale(pH) +
                          Mycorrhiza:scale(Agg_stability), 
                        data = fulldata,family = "nbinom1")

mod1.4 <- glmmadmb(Mycorrhiza ~ scale(mean_rootsize) + species + 
                          scale(pH)+ scale(Agg_stability) + Nutrient_PC1 + (1 | pop)+
                          Mycorrhiza:Nutrient_PC1 + Mycorrhiza:scale(mean_rootsize) +
                          Mycorrhiza:species + Mycorrhiza:scale(pH) +
                          Mycorrhiza:scale(Agg_stability), 
                        data = fulldata,family = "nbinom1")

X1<-residuals(mod10.Colin.NM)
X2<-residuals(mod1.4)
df<-as.data.frame(cbind(X1,X2))
PartialResidMycLesion<-ggplot(df, aes(X1,X2))+geom_smooth(method="lm")+geom_point()+
  theme_simple()+
  ggtitle("Added Variable plot of\nMycorrhiza effect on Lesion")+
  labs(x="Residuals of Mycorrhiza", y="Residuals of Lesions")+
  theme_bw()+
  theme(legend.title=element_blank(),plot.title = element_text(hjust = 0.5,face="bold", size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.title.x = element_text(size=18),axis.title.y = element_text(size=18),axis.text.y = element_text(size=10),panel.border = element_rect(colour = "black"),strip.background = element_rect(colour = "black",fill="white"),strip.text.x = element_text(size = 12))
PartialResidMycLesion
ggsave(file="PartialResidMycLesion.eps", plot=PartialResidMycLesion, width=10, height=8)

```
```{r Model based figure root size VS lesion in soil}
hist(fulldata$mean_rootsize)
lmod10.meanrs <- lm(mean_rootsize ~ Mycorrhiza + species + 
                          scale(pH)+ scale(Agg_stability) + Nutrient_PC1,data = fulldata)
plot(lmod10.meanrs)
#athough its not "normal" the residuals and the heteroskedasticity is good so ill keep it

mod10.noRS <- glmmadmb(Lesion ~ Mycorrhiza + species + 
                          scale(pH)+ scale(Agg_stability) + Nutrient_PC1 + (1 | pop)+
                          Mycorrhiza:Nutrient_PC1 + Mycorrhiza:scale(mean_rootsize) +
                          Mycorrhiza:species + Mycorrhiza:scale(pH) +
                          Mycorrhiza:scale(Agg_stability), 
                        data = fulldata,family = "nbinom1")

mod10.meanrs <- lmer(mean_rootsize ~ Mycorrhiza + species + 
                          scale(pH)+ scale(Agg_stability) + Nutrient_PC1 + (1 | pop)+
                          Mycorrhiza:Nutrient_PC1 + Mycorrhiza:scale(mean_rootsize) +
                          Mycorrhiza:species + Mycorrhiza:scale(pH) +
                          Mycorrhiza:scale(Agg_stability), 
                        data = fulldata)
X1<-residuals(mod10.noRS)
X2<-residuals(mod10.meanrs)
df<-as.data.frame(cbind(X1,X2))
PartialResidRootSizeLesion<-ggplot(df, aes(X1,X2))+geom_smooth(method="lm")+geom_point()+
  theme_simple()+
  ggtitle("Added Variable plot of\nRoot Size effect on Lesion")+
  labs(x="Residuals of Root Size", y="Residuals of Lesions")+
  theme_bw()+
  theme(legend.title=element_blank(),plot.title = element_text(hjust = 0.5,face="bold", size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),axis.title.x = element_text(size=18),axis.title.y = element_text(size=18),axis.text.y = element_text(size=10),panel.border = element_rect(colour = "black"),strip.background = element_rect(colour = "black",fill="white"),strip.text.x = element_text(size = 12))
PartialResidRootSizeLesion
ggsave(file="PartialResidRootSizeLesion.eps", plot=PartialResidRootSizeLesion, width=10, height=8)

```



```{r soil myc}
# model myc 
mod2 <- glmmadmb(binmycorrF ~ scale(mean_rootsize) * species + scale(pH) + scale(Agg_stability) + scale(N_percent) + scale(C_percent) + (1 | pop) , data = fulldata,family = "binomial")

mod1.4<-glmmadmb(Mycorrhiza ~ scale(mean_rootsize) * species + scale(pH) + scale(Agg_stability) + scale(N_percent) + scale(C_percent) + (1 | pop), data = fulldata,family="nbinom1")

mod2.1<-glmmadmb(Mycorrhiza ~ scale(mean_rootsize) * species + scale(pH) + scale(Agg_stability) + scale(N_percent) + scale(C_percent) + (1 | pop), data = fulldata,family="poisson")

ICtab(mod2, mod1.4, mod2.1, type='AICc')

summary(mod1.4)



var<-fulldata[,c(5,6,8,9,21)]
covar_cor = cor(var)
corrplot.mixed(covar_cor, upper = "ellipse", lower = "number")
sparrow_PCA = dudi.pca(covariates)
2

mod1.4.dredge <- dredge(mod1.4)
mod1.4.dredgegood <- subset(mod1.4.dredge,mod1.4.dredge$delta<=7)
mod1.4.avg<-model.avg(mod1.4.dredgegood)
summary(mod1.4.avg)


```

### Does root size influence how myc protect from lesion?
```{r rootsize}
Root_size$mean_rootsize <- rowSums(Root_size[,2:11])/length(Root_size[,2:11])
names(Root_size)[1]<-"indiv2"

fdata_rs <- merge(fdata, Root_size, by=c("indiv2","location","pop","species"))

## Mycorrhiza model (NOTE: No loc*species because not all species present in all populations)
base.Les<-glmmadmb(Lesion~ Mycorrhiza * species * location * mean_rootsize +(1|pop),data=fdata_rs,family = "binomial", extra.args="-ndi 30000")

Les2<-glmmadmb(Lesion ~ Mycorrhiza * species * location * mean_rootsize +(1|pop)-Mycorrhiza:species:location:mean_rootsize,data=fdata_rs,family = "binomial", extra.args="-ndi 30000")

anova(base.Les,Les2)

Les3a<-glmmadmb(Lesion~Mycorrhiza * species * location * mean_rootsize +(1|pop) -species:mean_rootsize,data=fdata_rs,family = "binomial", extra.args="-ndi 30000")
Les3b<-glmmadmb(Lesion~Mycorrhiza * species * location * mean_rootsize +(1|pop) -species:mean_rootsize:location,data=fdata_rs,family = "binomial", extra.args="-ndi 30000")
Les3c<-glmmadmb(Lesion~Mycorrhiza * species * location * mean_rootsize +(1|pop) -Mycorrhiza:mean_rootsize,data=fdata_rs,family = "binomial", extra.args="-ndi 30000")
anova(base.Les,Les3a) # TEST species*rootsize 
anova(base.Les,Les3b) # TEST Myc*location*rootsize 
anova(base.Les,Les3c) # TEST Myc*rootsize
```

Correlation model

```{r}
# calculating the r
indivCODE <- as.character(unique(fdata_rs$indiv2))
dfcorr <-data.frame(indiv2=c(0),r=c(0))
for (i in 1:length(indivCODE)){
  dat1<-NULL
  dat1<-fdata_rs[fdata_rs$indiv2==indivCODE[i],]
  dfcorr[i,1] <- indivCODE[i]
  dfcorr[i,2] <- cor(as.numeric(dat1$Mycorrhiza),as.numeric(dat1$Lesion))
}
dfcorr %>% drop_na()->dfcorr

fdata_rs.corr <- merge(dfcorr, Root_size, by="indiv2")
shapiro.test(fdata_rs.corr$r)

fdata_rs.corr$r.t<-fdata_rs.corr$r+1
CorrLM<-lm(r.t~ species * location * mean_rootsize,data=fdata_rs.corr)

bc<-boxcox(CorrLM, lambda = seq(-2, 2, 0.1))
lambda <- bc$x[which.max(bc$y)]
fdata_rs.corr <- cbind(fdata_rs.corr, ((fdata_rs.corr$r.t^lambda)-1)/lambda)
names(fdata_rs.corr)[length(fdata_rs.corr)] <- "Yprime"
shapiro.test(fdata_rs.corr$Yprime)
hist(fdata_rs.corr$Yprime)

CorrLMERBC<-lmer(Yprime~ species + location + mean_rootsize + 
                   location:species +
                   (1|pop),
                 data=fdata_rs.corr)
pr<-resid(CorrLMERBC, type='pearson')
n<-nrow(fdata_rs.corr)
c<-length(coef(CorrLMERBC))
(Disp<-sum(pr^2)/(n-c))

plot(effect("location:mean_rootsize", CorrLMERBC))
plot(effect("mean_rootsize", CorrLMERBC))

summary(CorrLMERBC)
CorrLMER.dredge<-dredge(CorrLMERBC)
r.squaredGLMM(CorrLMERBC)
```

# Molecular data Analysis

## Hypothesis 1: Mycorrhiza_div ~ invasion


## Hypothesis 2: Mycorrhiza_div ~ Pathoge_div

















